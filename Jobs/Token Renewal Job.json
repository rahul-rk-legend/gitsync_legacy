{
    "lastRunStatus": 0,
    "lastRunTime": 1764144832779,
    "uniqueIdentifier": "59f657ce-aa4f-4bba-a916-7ea0febfb8ae",
    "id": 0,
    "jobDefinitionId": 0,
    "name": "Token Renewal Job",
    "integration": "Exchange",
    "script": "from __future__ import annotations\n\nfrom collections.abc import MutableMapping\n\nfrom TIPCommon.base.job import RefreshTokenRenewalJob, validate_param_csv_to_multi_value\n\nfrom ExchangeManager import ExchangeManager\nfrom constants import INTEGRATION_NAME, TOKEN_RENEWAL_SCRIPT_NAME\nfrom exceptions import ExchangeManagerError\n\n\nclass RefreshTokenJob(RefreshTokenRenewalJob):\n    \"\"\"\n    Refresh Token Renewal Job to update refresh token periodically.\n    \"\"\"\n\n    def __init__(self, script_name: str, integration_identifier: str) -> None:\n        super().__init__(script_name, integration_identifier)\n        self.error_msg = f\"{script_name} failed to run because \"\n\n    def _get_integration_envs(self) -> str:\n        return self.params.integration_environments\n\n    def _get_connector_names(self) -> str:\n        return self.params.connector_names\n\n    def _validate_params(self) -> None:\n        \"\"\"Validate the parameters values.\n\n        Raises:\n           ExchangeManagerError: In case of integration environments and\n               connector names are not provided.\n        \"\"\"\n        self.params.integration_environments = validate_param_csv_to_multi_value(\n            param_name=\"Integration Environments\",\n            param_csv_value=self.params.integration_environments,\n        )\n        self.params.connector_names = validate_param_csv_to_multi_value(\n            param_name=\"Connector Names\",\n            param_csv_value=self.params.connector_names,\n        )\n        if not self.params.integration_environments and not self.params.connector_names:\n            raise ExchangeManagerError(\n                f\"{self.error_msg} both Integration Environments \"\n                \"and Connector Names parameters are not provided.\"\n            )\n\n    def _build_manager_for_instance(\n        self,\n        instance_settings: MutableMapping[str, str],\n    ) -> ExchangeManager:\n        \"\"\"Build Manager object to get the refresh token for integration/connector\n        instances.\n\n        Args:\n            instance_settings (MutableMapping[str, str]): instance configuration\n            settings.\n\n        Returns:\n            ExchangeManager: exception while creating ExchangeManager object.\n        \"\"\"\n        try:\n            return ExchangeManager(\n                exchange_server_ip=instance_settings.get(\n                    \"ServerAddress\", instance_settings.get(\"Mail Server Address\")\n                ),\n                domain=None,\n                user_mail_address=instance_settings.get(\"Mail Address\"),\n                siemplify_logger=self.logger,\n                client_id=instance_settings.get(\"Client ID\"),\n                client_secret=instance_settings.get(\"Client Secret\"),\n                tenant_id=instance_settings.get(\"Tenant (Directory) ID\"),\n                auth_token=instance_settings.get(\"Refresh Token\"),\n                verify_ssl=instance_settings.get(\"Verify SSL\").lower() == \"true\",\n            )\n        except Exception as e: # pylint: disable=broad-except\n            self.logger.error(\n                \"This instance isn't set up to be used with Oauth, aborting ...\"\n            )\n            self.logger.exception(e)\n            return None\n\n    def _refresh_integration_token(self, instance_identifier: str) -> None:\n        \"\"\"Renew refresh token and set it in integration's configuration.\n\n        Args:\n            instance_identifier (str): integration instance identifier.\n                e.g.: \"ce0027a2-2b53-4cce-ad08-430df6d002f3\"\n        \"\"\"\n        refresh_token = self.api_client.credentials.access_token[\"refresh_token\"]\n        self.soar_job.set_configuration_property(\n            integration_instance_identifier=instance_identifier,\n            property_name=\"Refresh Token\",\n            property_value=refresh_token,\n        )\n\n    def _refresh_connector_token(self, instance_identifier: str) -> None:\n        \"\"\"Renew refresh token and set it in connector's configuration.\n        Args:\n            instance_identifier (str): connector instance identifier.\n                e.g.: \"Test_OauthConnector_75098aae-de81-44cc-a807-4843d5ae7ea5\"\n        \"\"\"\n        refresh_token = self.api_client.credentials.access_token[\"refresh_token\"]\n        self.soar_job.set_connector_parameter(\n            connector_instance_identifier=instance_identifier,\n            parameter_name=\"Refresh Token\",\n            parameter_value=refresh_token,\n        )\n\n\ndef main() -> None:\n    RefreshTokenJob(TOKEN_RENEWAL_SCRIPT_NAME, INTEGRATION_NAME).start()\n\n\nif __name__ == \"__main__\":\n    main()\n",
    "creator": "admin",
    "description": "Token renewal job should be used to periodically update the refresh token configured for the integration. By default, the refresh token expires every 90 days, making integration unusable upon expiration. It is recommended to run this job every 7 or 14 days to make sure that refresh token will be up to date.",
    "isEnabled": false,
    "isCustom": false,
    "version": 1,
    "parameters": [
        {
            "id": 1,
            "isMandatory": false,
            "name": "Integration Environments",
            "type": 2,
            "value": "Default Environment"
        },
        {
            "id": 2,
            "isMandatory": false,
            "name": "Connector Names",
            "type": 2,
            "value": "Exchange Mail Connector v2 with Oauth Authentication"
        }
    ],
    "runIntervalInSeconds": 3600,
    "creationTime": "2025-11-26T08:11:19.706Z",
    "lastModificationTime": "2025-11-26T08:13:52.788Z",
    "isSystemJob": false,
    "jobDefinitionName": "Token Renewal Job",
    "agentIdentifier": null,
    "advanced": false,
    "advancedConfig": null
}